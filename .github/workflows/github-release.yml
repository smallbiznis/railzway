name: GitHub Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  github-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build release notes from changelog
        run: |
          version="${{ steps.version.outputs.version }}"
          notes="release_notes.md"
          awk -v version="$version" '
            $0 ~ "^## \\[" version "\\]" {flag=1; print; next}
            flag && $0 ~ "^## \\[" {exit}
            flag {print}
          ' CHANGELOG.md > "$notes"

          if [ ! -s "$notes" ]; then
            echo "Release notes not found for version ${version} in CHANGELOG.md"
            exit 1
          fi

          {
            echo ""
            echo "## Docker Image"
            echo ""
            echo "ghcr.io/${{ github.repository_owner }}/valora:${{ steps.version.outputs.tag }}"
          } >> "$notes"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Valora OSS ${{ steps.version.outputs.tag }}
          body_path: release_notes.md
